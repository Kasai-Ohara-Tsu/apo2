{% extends "frontend/base.html" %}

{% load static %}

{% block title %}æ‹…å½“è€…æ¤œç´¢{% endblock %}

{% block content %}

<div class="container-wide">
    <h1 class="text-center mb-4 text-color">æ‹…å½“è€…æ¤œç´¢</h1>

    <div class="d-flex justify-content-center gap-3 mb-4">
        <button class="btn btn-primary-custom" id="dept-tab-btn" onclick="switchTab('department')">éƒ¨ç½²ã‹ã‚‰æ¤œç´¢</button>
        <button class="btn btn-secondary-custom" id="name-tab-btn" onclick="switchTab('name')">åå‰ã‹ã‚‰æ¤œç´¢</button>
    </div>

    <!-- éƒ¨ç½²ã‚¿ãƒ– -->
    <div id="department-tab" class="tab-content mb-4"
        style="max-height: calc(100vh - 150px); overflow-y: auto; display: block;">
        <div class="border rounded p-3">
            {% if departments_data %}
            <div class="d-flex justify-content-center mb-4">
                <div style="width: 100%; max-width: 500px;">
                    <label for="dept-select" class="form-label fw-bold">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                    <select id="dept-select" class="form-select form-select-lg shadow-sm"
                        onchange="showDepartmentStaff(this.value)">
                        {% for dept in departments_data %}
                        <option value="{{ dept.id }}" {% if forloop.first %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <!-- å„æœ¬éƒ¨ãƒ»èª²ã”ã¨ã®ç¤¾å“¡ãƒªã‚¹ãƒˆ -->
            {% for dept in departments_data %}
            <div class="department-staff" id="dept-{{ dept.id }}"
                style="{% if forloop.first %}display:block;{% else %}display:none;{% endif %}">
                <h5 class="mb-3 fw-bold">{{ dept.name }}</h5>

                <!-- æœ¬éƒ¨ç›´ä¸‹ç¤¾å“¡ -->
                {% if dept.staff_list %}
                <div class="department-staff-list d-flex flex-wrap gap-3 justify-content-center mb-3">
                    {% for staff in dept.staff_list %}
                    <div class="card staff-card shadow-sm text-center" style="width:200px; cursor:pointer;"
                        onclick="selectStaff('{{ staff.id }}','{{ staff.name }}')">
                        <!-- ä¸ŠåŠåˆ†ã«ç”»åƒ -->
                        <div class="staff-photo-top">
                            {% if staff.photo_url %}
                            <img src="{{ staff.photo_url.url }}" alt="{{ staff.name }}" class="img-top">
                            {% else %}
                            <img src="{% static 'images/default.png' %}" alt="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒ" class="img-top">
                            {% endif %}
                        </div>
                        <!-- ä¸‹åŠåˆ†ã«ãƒ†ã‚­ã‚¹ãƒˆ -->
                        <div class="p-2">
                            <div class="fw-bold staff-name-marked">{{ staff.name }}</div>
                            <div class="text-muted small">{{ staff.position }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- èª²ã”ã¨ã®ç¤¾å“¡ -->
                {% for section in dept.sections %}
                <h5 class="mt-3 fw-bold">{{ section.full_name }}</h5>
                {% if section.staff_list %}
                <div class="department-staff-list d-flex flex-wrap gap-3 justify-content-center mb-3">
                    {% for staff in section.staff_list %}
                    <div class="card staff-card shadow-sm text-center" style="width:200px; cursor:pointer;"
                        onclick="selectStaff('{{ staff.id }}','{{ staff.name }}')">
                        <!-- ä¸ŠåŠåˆ†ã«ç”»åƒ -->
                        <div class="staff-photo-top">
                            {% if staff.photo_url %}
                            <img src="{{ staff.photo_url.url }}" alt="{{ staff.name }}" class="img-top">
                            {% else %}
                            <img src="{% static 'images/default.png' %}" alt="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒ" class="img-top">
                            {% endif %}
                        </div>
                        <!-- ä¸‹åŠåˆ†ã«ãƒ†ã‚­ã‚¹ãƒˆ -->
                        <div class="p-2">
                            <div class="fw-bold staff-name-marked">{{ staff.name }}</div>
                            <div class="text-muted small">{{ staff.position }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small">ç¤¾å“¡ã¯ã„ã¾ã›ã‚“</p>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}

            {% else %}
            <p class="text-muted">éƒ¨ç½²æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>
    </div>

    <!-- åå‰æ¤œç´¢ã‚¿ãƒ– -->
    <div id="name-tab" class="tab-content" style="display:none;">
        <form id="search-form" onsubmit="event.preventDefault(); filterStaff();" class="mb-2">
            <div class="input-group mb-2">
                <input type="text" id="search-input" class="form-control input-large" placeholder="åå‰ã§æ¤œç´¢..." />
            </div>
        </form>

        <div class="search-result-container border rounded p-3">
            {% if staff_list %}
            <div id="staff-list">
                {% for staff in staff_list %}
                <div class="card-staff mb-2 staff-item" data-name="{{ staff.name }}"
                    data-kana="{{ staff.name_kana|default:'' }}" data-id="{{ staff.id }}"
                    data-position="{{ staff.position }}" data-department_full="{{ staff.department_full_name }}">
                    <div class="d-flex gap-3 staff-card-clickable text-color" data-staff-id="{{ staff.id }}"
                        data-staff-name="{{ staff.name }}">
                        <div class="staff-photo-name">ğŸ‘¤</div>
                        <div class="flex-grow-1">
                            <div class="fw-bold staff-name-marked">{{ staff.name }}</div>
                            <div class="small staff-meta">{{ staff.department_full_name }} {{ staff.position }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">ç¤¾å“¡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
        <a href="{% url 'frontend:visitor_info' %}"
            class="btn btn-secondary-custom btn-large d-flex align-items-center justify-content-center"
            style="width:12rem;">
            â† æˆ»ã‚‹
        </a>
    </div>

</div>

<script>
    /* ---------- æ­£è¦åŒ–ãƒ»å¤‰æ›ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------- */

    function normalizeNFKC(str) { return (str || "").normalize ? str.normalize('NFKC') : (str || ""); }

    // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
    function kataToHira(str) {
        if (!str) return "";
        return String(str).replace(/[\u30a1-\u30f6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
    }

    // ä¿ƒéŸ³ãƒ»å°æ›¸ãï¼ˆã‚ƒã‚…ã‚‡ããƒ...ï¼‰ã¯ãã®ã¾ã¾æ‰±ã†ãŒ normalize ã§è½ã¡ç€ã‹ã›ã‚‹
    function simpleClean(str) {
        return normalizeNFKC(str || "").trim().replace(/\s+/g, '').replace(/ãƒ¼/g, '').toLowerCase();
    }

    /* ãƒ­ãƒ¼ãƒå­— -> ã²ã‚‰ãŒãªãƒãƒƒãƒ—ï¼ˆè²ªæ¬²ï¼‰ */
    const ROMAJI_MAP = {
        "kya": "ãã‚ƒ", "kyu": "ãã‚…", "kyo": "ãã‚‡", "sha": "ã—ã‚ƒ", "shu": "ã—ã‚…", "sho": "ã—ã‚‡",
        "cha": "ã¡ã‚ƒ", "chu": "ã¡ã‚…", "cho": "ã¡ã‚‡", "nya": "ã«ã‚ƒ", "nyu": "ã«ã‚…", "nyo": "ã«ã‚‡",
        "hya": "ã²ã‚ƒ", "hyu": "ã²ã‚…", "hyo": "ã²ã‚‡", "mya": "ã¿ã‚ƒ", "myu": "ã¿ã‚…", "myo": "ã¿ã‚‡",
        "rya": "ã‚Šã‚ƒ", "ryu": "ã‚Šã‚…", "ryo": "ã‚Šã‚‡", "gya": "ãã‚ƒ", "gyu": "ãã‚…", "gyo": "ãã‚‡",
        "ja": "ã˜ã‚ƒ", "ju": "ã˜ã‚…", "jo": "ã˜ã‚‡", "bya": "ã³ã‚ƒ", "byu": "ã³ã‚…", "byo": "ã³ã‚‡",
        "pya": "ã´ã‚ƒ", "pyu": "ã´ã‚…", "pyo": "ã´ã‚‡",
        "shi": "ã—", "chi": "ã¡", "tsu": "ã¤", "fu": "ãµ", "ji": "ã˜",
        "ka": "ã‹", "ki": "ã", "ku": "ã", "ke": "ã‘", "ko": "ã“",
        "sa": "ã•", "si": "ã—", "su": "ã™", "se": "ã›", "so": "ã",
        "ta": "ãŸ", "ti": "ã¡", "tu": "ã¤", "te": "ã¦", "to": "ã¨",
        "na": "ãª", "ni": "ã«", "nu": "ã¬", "ne": "ã­", "no": "ã®",
        "ha": "ã¯", "hi": "ã²", "hu": "ãµ", "he": "ã¸", "ho": "ã»",
        "ma": "ã¾", "mi": "ã¿", "mu": "ã‚€", "me": "ã‚", "mo": "ã‚‚",
        "ya": "ã‚„", "yu": "ã‚†", "yo": "ã‚ˆ", "ra": "ã‚‰", "ri": "ã‚Š", "ru": "ã‚‹", "re": "ã‚Œ", "ro": "ã‚",
        "wa": "ã‚", "wo": "ã‚’", "n": "ã‚“",
        "ga": "ãŒ", "gi": "ã", "gu": "ã", "ge": "ã’", "go": "ã”",
        "za": "ã–", "zi": "ã˜", "zu": "ãš", "ze": "ãœ", "zo": "ã",
        "da": "ã ", "di": "ã¢", "du": "ã¥", "de": "ã§", "do": "ã©",
        "ba": "ã°", "bi": "ã³", "bu": "ã¶", "be": "ã¹", "bo": "ã¼",
        "pa": "ã±", "pi": "ã´", "pu": "ã·", "pe": "ãº", "po": "ã½",
        "a": "ã‚", "i": "ã„", "u": "ã†", "e": "ãˆ", "o": "ãŠ"
    };

    // ãƒ­ãƒ¼ãƒå­— -> ã²ã‚‰ãŒãªï¼ˆè²ªæ¬²ãƒãƒƒãƒï¼‰
    function romajiToHiragana(input) {
        if (!input) return "";
        let s = simpleClean(input);
        let out = "";
        let i = 0;
        while (i < s.length) {
            // ä¿ƒéŸ³ï¼ˆå­éŸ³äºŒé‡ï¼‰å‡¦ç†
            if (i + 1 < s.length && s[i] === s[i + 1] && /[bcdfghjklmnpqrstvwxyz]/.test(s[i])) {
                out += "ã£"; i++; continue;
            }
            // try 3,2,1
            let matched = null;
            if (i + 3 <= s.length) {
                const c3 = s.substr(i, 3);
                if (ROMAJI_MAP[c3]) matched = ROMAJI_MAP[c3];
            }
            if (!matched && i + 2 <= s.length) {
                const c2 = s.substr(i, 2);
                if (ROMAJI_MAP[c2]) matched = ROMAJI_MAP[c2];
            }
            if (!matched) {
                const c1 = s.substr(i, 1);
                if (ROMAJI_MAP[c1]) matched = ROMAJI_MAP[c1];
            }
            if (matched) { // advance by length of matched key
                // find length
                if (i + 3 <= s.length && ROMAJI_MAP[s.substr(i, 3)]) { out += ROMAJI_MAP[s.substr(i, 3)]; i += 3; }
                else if (i + 2 <= s.length && ROMAJI_MAP[s.substr(i, 2)]) { out += ROMAJI_MAP[s.substr(i, 2)]; i += 2; }
                else { out += ROMAJI_MAP[s.substr(i, 1)]; i += 1; }
            } else {
                i++;
            }
        }
        return out;
    }

    // çµ±ä¸€ï¼šä»»æ„ã®å…¥åŠ›ï¼ˆãƒ­ãƒ¼ãƒå­—/ã‚«ãƒŠ/æ¼¢å­—/ã²ã‚‰ãŒãªï¼‰ã‚’ã€Œã²ã‚‰ãŒãªæ–‡å­—åˆ—ã€ã«ã™ã‚‹
    function toHiraganaUnified(src) {
        if (!src) return "";
        let s = normalizeNFKC(src);
        // ãƒ­ãƒ¼ãƒå­—ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ãƒ­ãƒ¼ãƒå­—â†’ã²ã‚‰ãŒãª
        if (/[a-zA-Z]/.test(s)) {
            return romajiToHiragana(s);
        }
        // ã‚«ã‚¿ã‚«ãƒŠã‚’ã²ã‚‰ãŒãªã«
        s = kataToHira(s);
        // æ­£è¦åŒ–ï¼ˆé•·éŸ³é™¤å»ãªã©ï¼‰
        s = s.replace(/ãƒ¼/g, '').replace(/\s+/g, '').toLowerCase();
        return s;
    }

    // æºã‚Œï¼šæ¿éŸ³â†’æ¸…éŸ³ ãªã©ã®å€™è£œã‚’ä½œã‚‹ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒ1æ–‡å­—ã®ã¨ãæœ‰åŠ¹ï¼‰
    function expandVariantsHira(hira) {
        if (!hira) return [hira];
        const dak = {
            "ãŒ": "ã‹", "ã": "ã", "ã": "ã", "ã’": "ã‘", "ã”": "ã“",
            "ã–": "ã•", "ã˜": "ã—", "ãš": "ã™", "ãœ": "ã›", "ã": "ã",
            "ã ": "ãŸ", "ã¢": "ã¡", "ã¥": "ã¤", "ã§": "ã¦", "ã©": "ã¨",
            "ã°": "ã¯", "ã³": "ã²", "ã¶": "ãµ", "ã¹": "ã¸", "ã¼": "ã»",
            "ã±": "ã¯", "ã´": "ã²", "ã·": "ãµ", "ãº": "ã¸", "ã½": "ã»"
        };
        const res = new Set([hira]);
        if (hira.length === 1 && dak[hira]) res.add(dak[hira]);
        return Array.from(res);
    }

    /* ---------- ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ ---------- */
    // ãƒ«ãƒ¼ãƒ«ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒ1æ–‡å­—ãªã‚‰ã€Œå…ˆé ­ä¸€è‡´ï¼ˆstartsWithï¼‰ã€ã§æ¤œç´¢ã€‚2æ–‡å­—ä»¥ä¸Šã¯éƒ¨åˆ†ä¸€è‡´ï¼ˆincludesï¼‰ã€‚
    // æ¯”è¼ƒå¯¾è±¡ã¯ staff ã® name_kanaï¼ˆDBã«ã‚ã‚‹ã‚«ãƒŠï¼‰ã‚’ã²ã‚‰ãŒãªåŒ–ã—ãŸã‚‚ã®ã€‚æ¼¢å­— name ã‚‚ã²ã‚‰ãŒãªåŒ–ã—ã¦å¿µã®ãŸã‚æ¯”è¼ƒã€‚

    function isMatchForTerm(itemName, itemKana, rawInput) {
        const termHira = toHiraganaUnified(rawInput);
        if (!termHira) return true; // ç©ºæ¤œç´¢ã¯è¡¨ç¤º

        const kanaH = toHiraganaUnified(itemKana || "");
        const nameH = toHiraganaUnified(itemName || "");

        // expand variants for 1-char term (æ¿éŸ³â†’æ¸…éŸ³ãªã©)
        const termsToTry = (termHira.length === 1) ? expandVariantsHira(termHira) : [termHira];

        for (const t of termsToTry) {
            if (t.length === 1) {
                if (kanaH.startsWith(t) || nameH.startsWith(t)) return true;
            } else {
                if (kanaH.includes(t) || nameH.includes(t)) return true;
            }
        }
        // fallback: raw ascii partial match on original name (for roman-latin mixed)
        const rawClean = simpleClean(rawInput);
        if (rawClean) {
            if ((itemName || "").toLowerCase().indexOf(rawClean) !== -1) return true;
        }
        return false;
    }

    /* ---------- UI: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å®Ÿè¡Œ ---------- */
    function filterStaff() {
        const raw = document.getElementById('search-input').value || "";
        // remove previous no-result
        const prev = document.getElementById('no-result');
        if (prev) prev.remove();

        const items = document.querySelectorAll('.staff-item');
        let hit = false;
        items.forEach(item => {
            const name = item.dataset.name || "";
            const kana = item.dataset.kana || "";
            const ok = isMatchForTerm(name, kana, raw);
            item.style.display = ok ? "block" : "none";
            // highlight if match (simple mark using hira index on nameH)
            const wrap = item.querySelector('.staff-name-marked');
            if (ok) {
                hit = true;
                // mark attempt: find index in nameH and map back roughly to original (best-effort)
                const termHira = toHiraganaUnified(raw);
                if (termHira) {
                    const nameH = toHiraganaUnified(name);
                    const idx = nameH.indexOf(termHira);
                    if (idx !== -1 && wrap) {
                        // naive: slice original by char counts (best-effort)
                        const pre = escapeHtml(name.slice(0, idx));
                        const mid = escapeHtml(name.slice(idx, idx + termHira.length));
                        const post = escapeHtml(name.slice(idx + termHira.length));
                        wrap.innerHTML = `${pre}<mark>${mid}</mark>${post}`;
                    } else {
                        wrap.innerHTML = escapeHtml(name);
                    }
                } else {
                    wrap.innerHTML = escapeHtml(name);
                }
            } else {
                if (wrap) wrap.innerHTML = escapeHtml(name);
            }
        });

        if (!hit) {
            const list = document.getElementById('staff-list');
            if (list) {
                list.insertAdjacentHTML('beforeend', '<p class="text-muted text-center mt-3" id="no-result">è©²å½“ã™ã‚‹ç¤¾å“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>');
            }
        }
    }

    /* ---------- DOM ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---------- */
    document.addEventListener('DOMContentLoaded', function () {
        // staff-cardã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
        document.querySelectorAll('.staff-card-clickable').forEach(card => {
            card.addEventListener('click', function () {
                selectStaff(this.dataset.staffId, this.dataset.staffName);
            });
        });

        const search = document.getElementById('search-input');
        if (search) {
            search.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); filterStaff(); } });
            let timer = null;
            search.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(filterStaff, 120); });
        }

        // åˆæœŸã¯å…¨è¡¨ç¤º
        filterStaff();
    });

    /* ---------- æ—¢å­˜é–¢æ•°ç¾¤ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬å†…ã«ã‚ã‚‹æ—¢å­˜ã®é–¢æ•°ã‚’ãã®ã¾ã¾åˆ©ç”¨ï¼‰ ---------- */
    function escapeHtml(str) {
        return String(str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
    }

    function switchTab(tab) {
        const deptBtn = document.getElementById('dept-tab-btn');
        const nameBtn = document.getElementById('name-tab-btn');

        document.getElementById('department-tab').style.display = (tab === 'department') ? 'block' : 'none';
        document.getElementById('name-tab').style.display = (tab === 'name') ? 'block' : 'none';

        if (tab === 'department') {
            deptBtn.className = 'btn btn-primary-custom';
            nameBtn.className = 'btn btn-secondary-custom';
        } else {
            deptBtn.className = 'btn btn-secondary-custom';
            nameBtn.className = 'btn btn-primary-custom';
        }
    }


    function showDepartmentStaff(deptId) {
        document.querySelectorAll('.department-staff').forEach(el => el.style.display = 'none');
        const block = document.getElementById('dept-' + deptId);
        if (block) block.style.display = 'block';
        document.querySelectorAll('.department-item').forEach(el => el.classList.remove('active-dept'));
        const deptItem = document.querySelector(`[data-dept-id="${deptId}"]`);
        if (deptItem) deptItem.classList.add('active-dept');
    }

    function selectStaff(id, name) {
        const urlParams = new URLSearchParams(window.location.search);
        const company = urlParams.get('visitor_company') || localStorage.getItem('visitor_company') || '';
        const visitor = urlParams.get('visitor_name') || localStorage.getItem('visitor_name') || '';
        const url = "{% url 'frontend:waiting' %}";
        const purpose_preset = new URLSearchParams(window.location.search).get('purpose_preset') || '';
        const purpose_custom = new URLSearchParams(window.location.search).get('purpose_custom') || '';

        const p = new URLSearchParams({
            staff_id: id,
            staff_name: name,
            visitor_company: company,
            visitor_name: visitor,
            purpose_preset: purpose_preset,
            purpose_custom: purpose_custom,
            visit_type: "appointment"
        });
        window.location.href = `${url}?${p.toString()}`;
    }


    function showDepartmentStaff(deptId) {
        // 1. ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆï¼ˆå„éƒ¨ç½²ã®ã‚³ãƒ³ãƒ†ãƒŠï¼‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        document.querySelectorAll('.department-staff').forEach(el => {
            el.style.display = 'none';
        });

        // 2. é¸æŠã•ã‚ŒãŸéƒ¨ç½²IDï¼ˆdeptIdï¼‰ã«ä¸€è‡´ã™ã‚‹ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
        const selectedDept = document.getElementById(`dept-${deptId}`);
        if (selectedDept) {
            selectedDept.style.display = 'block';

            // ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ï¼ˆãƒªã‚¹ãƒˆãŒé•·ã„å ´åˆã®åˆ©ä¾¿æ€§ï¼‰
            selectedDept.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
</script>
{% endblock %}